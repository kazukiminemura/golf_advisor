# 要件定義書

## システム概要
- 本システムは2本のゴルフスイング動画を比較し、OpenVINOを用いた姿勢推定とチャットボットによる助言を提供する


- Python 3.8以上とOpenVINOなどのライブラリを前提とする



## 機能要件
1. **動画解析**
   - 参照動画と比較対象動画から姿勢キーポイントを抽出する


   - 抽出したキーポイントを比較し、スイング類似度スコアを計算する


2. **詳細分析**
   - 総合スコア、部位別差異、フェーズ別スコア、姿勢・テンポ・バランス解析を実施する



3. **対話型コーチング**
   - 解析結果に基づいた日本語のコーチング応答を行う強化チャットボットを提供する


4. **表示機能**
   - Tkinterを利用し、動画比較画面とチャットパネルを同時表示できる


   - Webページ上で動画と骨格オーバーレイを表示し、解析後のスコアを示す



5. **CLI操作**
   - 解析のみ、チャット表示、OpenPose結果表示などのオプションを提供するコマンドライン引数を備える


6. **Web API**
   - 動画アップロード、解析実行、チャットボット連携、リソース使用率取得などのエンドポイントを提供する





   - チャットボットは標準で有効で、`ENABLE_CHATBOT=0` により無効化でき、遅延初期化は `LAZY_CHATBOT_INIT` で制御可能


7. **一般向けチャット**
    - `simple_chatbot.py` に基づく軽量LLMチャットボットを `/chat` ページで提供する（デフォルトは OpenVINO で動作する Qwen 系モデル）




## 非機能要件
- CPU/GPU/NPUの使用率を取得して表示する



- 解析済み成果物（スコア、キー ポイントJSON、動画）を再利用し、再解析を避ける



---

# 詳細設計書

## モジュール構成
1. **golf_swing_compare.py**
   - `load_model`/`preprocess`/`postprocess`でOpenVINOモデル読み込みと前後処理を行う


   - `extract_keypoints`で動画からフレーム毎にキーポイントを抽出


   - `compare_swings`でキーポイント差分を平均化し指数関数でスコア化


   - `GolfSwingAnalyzer`が各種詳細解析を行い、フェーズ分割・姿勢・テンポ・バランスの指標を算出



   - `EnhancedSwingChatBot`が解析結果をもとに`SimpleChatBot`で文章を生成し、対象フェーズ別に応答を返す


   - `show_comparison_with_chat`/`show_comparison`で動画比較表示を行い、前者はチャットUIと連携


   - `main`関数でCLI引数を解析し、解析のみ・動画表示・チャット起動などの処理分岐を実装


2. **app.py**
   - Flaskアプリとして動画解析ワークフローを非同期で実行し、キー ポイント抽出・スコア算出・動画アノテーションを `_prepare_videos_sync` にまとめる


   - `/messages` エンドポイントでスイング用チャットボットとの対話を管理し、履歴を保持


   - `/analyze`で解析を開始し、必要に応じてチャットボットを自動初期化


   - `/set_videos`で入力動画や推論デバイスを切り替え、過去解析結果をリセット


   - `/system_usage`でCPU/GPU/NPUおよびメモリの使用率を返却



3. **simple_chatbot.py**
    - `SimpleChatBot` が Qwen などのLLMをバックエンド経由でロードし、会話履歴を維持しながら応答を生成する



4. **templates/index.html**
   - 動画再生と骨格描画用キャンバス、チャット用UI、デバイス選択や解析ボタンを含むレイアウトを定義


   - JavaScriptでキーポイントJSONを読み込み、動画再生に合わせて骨格を描画する




## 処理フロー概要
1. ユーザーが動画を指定し解析を開始すると、`_prepare_videos_sync` がキー ポイント抽出・スコア計算・アノテーション・JSON保存を実行。
2. 解析完了後、CLIまたはWeb UIでスコア・骨格付き動画を表示。
3. チャットボットが `GolfSwingAnalyzer` の結果を利用してユーザー質問に応じた助言を返す。
4. `/system_usage`などのAPIによりサーバー負荷情報を取得してフロントエンドで可視化。

---

## Testing
⚠️ テストスクリプトや自動テストは本リポジトリに含まれておらず、仕様書作成のためコード読解のみを実施しました。

