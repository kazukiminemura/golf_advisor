# 要件定義書

## システム概要
- Webベースのゴルフスイング比較・コーチングシステム。
- FastAPIを利用して2本のスイング動画から姿勢キーポイントを抽出し、OpenVINO推論とチャットボットにより助言を提供する。

## 前提条件
- Python 3.8以上
- OpenVINOランタイムおよび必要ライブラリ
- Qwen2.5系LLMモデル（デフォルト）
- CPU/GPU/NPUいずれかのデバイスで推論可能

## 機能要件
1. **動画管理**
   - 参照・対象動画の選択、アップロード、一覧取得
   - `/upload_videos`、`/list_videos`、`/set_videos` API
2. **姿勢解析とスコア計算**
   - OpenVINOモデルでキーポイント抽出しスイングスコア算出
   - 解析結果として骨格描画済み動画とキーポイントJSONを生成・再利用
   - `/analyze` APIで実行
3. **チャットボット**
   - 解析結果を利用したスイング特化チャットボット
   - 一般向け軽量チャットボットページ `/chat`
   - REST/WebSocketでの対話（`/messages`、`/chat_messages`、`/ws/messages`）
4. **リソース監視**
   - CPU/GPU/NPUやメモリ使用率取得 `/system_usage`
5. **フロントエンド表示**
   - indexページで動画再生・骨格オーバーレイ・スコア表示・デバイス選択・チャットUI

## 非機能要件
- 起動時にモデルを非同期でウォームアップし応答性を維持
- 解析済み成果物が存在する場合は再解析を回避
- チャットボット機能は環境変数で有効/無効切替および遅延初期化が可能
- 会話履歴は最大20件まで保持
- GPUがない環境でも動作し、使用率取得に失敗した場合は0%を返す

## API一覧
| メソッド | パス | 概要 |
|---------|-----|------|
| GET | `/` | 解析結果とチャットUIを含むトップページ |
| GET | `/chat` | 一般チャットページ |
| GET/POST | `/chat_messages` | 一般チャットボットとの対話 |
| GET/POST | `/messages` | スイングチャットボットとの対話 |
| WebSocket | `/ws/messages` | スイングチャットボットのリアルタイム対話 |
| POST | `/upload_videos` | 動画アップロード |
| GET | `/list_videos` | 動画一覧取得 |
| POST | `/set_videos` | 使用動画とデバイス設定 |
| POST | `/analyze` | 動画解析実行 |
| POST | `/init_chatbot` | チャットボット初期化 |
| GET | `/chatbot_status` | チャットボット状態取得 |
| GET | `/system_usage` | H/W使用率取得 |
| GET | `/videos/{filename}` | 保存済み動画の提供 |
