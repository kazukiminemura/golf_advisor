<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>チャットボット</title>
  <style>
    body { display: flex; flex-direction: column; height: 100vh; margin: 0; }
    #chat-messages { flex: 1; border: 1px solid #ccc; overflow-y: auto; margin: 10px; padding: 5px; }
    .chat-input { display: flex; padding: 10px; }
    .chat-input input { flex: 1; padding: 5px; }
    .chat-input button { margin-left: 5px; }
  </style>
</head>
<body>
  <div id="chat-messages"></div>
  <div class="chat-input">
    <input id="chat-input" type="text" placeholder="メッセージを入力..." />
    <button id="send-btn">送信</button>
  </div>
  <script>
    async function loadMessages() {
      const res = await fetch('/chat_messages');
      const msgs = await res.json();
      const box = document.getElementById('chat-messages');
      box.innerHTML = '';
      msgs.forEach(m => {
        const p = document.createElement('p');
        const prefix = m.role === 'user' ? 'あなた: ' : 'ボット: ';
        p.textContent = prefix + m.content;
        box.appendChild(p);
      });
      box.scrollTop = box.scrollHeight;
    }

    document.getElementById('send-btn').onclick = async () => {
      const input = document.getElementById('chat-input');
      const text = input.value.trim();
      if (!text) return;
      const box = document.getElementById('chat-messages');

      const userP = document.createElement('p');
      userP.textContent = 'あなた: ' + text;
      box.appendChild(userP);
      box.scrollTop = box.scrollHeight;
      input.value = '';

      try {
        const res = await fetch('/chat_messages', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: text })
        });
        const data = await res.json();
        const botP = document.createElement('p');
        botP.textContent = 'ボット: ' + data.reply;
        box.appendChild(botP);
        box.scrollTop = box.scrollHeight;
      } catch (e) {
        const errP = document.createElement('p');
        errP.textContent = 'ボット: 応答に失敗しました。';
        box.appendChild(errP);
        box.scrollTop = box.scrollHeight;
      }
    };

    loadMessages();
  </script>
</body>
</html>
