<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>チャット & 動画</title>
  <style>
    body { display: flex; height: 100vh; margin: 0; }
    .video-container, .chat-container { flex: 1; padding: 10px; box-sizing: border-box; }
    .chat-container { display: flex; flex-direction: column; }
    #chat-messages { flex: 1; border: 1px solid #ccc; overflow-y: auto; margin-bottom: 10px; padding: 5px; }
    .chat-input { display: flex; }
    .chat-input input { flex: 1; padding: 5px; }
    .chat-input button { margin-left: 5px; }
    .chat-status {
      background: #f0f0f0;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 5px;
      text-align: center;
      font-weight: bold;
    }
    .chat-status.preparing { background: #fff3cd; color: #856404; }
    .chat-status.ready { background: #d4edda; color: #155724; }
    .chat-status.error { background: #f8d7da; color: #721c24; }
    .video-wrapper { display: flex; }
    .video-item { position: relative; flex: 1; }
    .video-item video { width: 100%; display: block; }
    .video-item canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
    .file-select { margin-bottom: 10px; }
    .file-select select { width: 45%; margin-right: 5px; }
    .file-select input[type="file"] {
      margin-right: 5px;
      font-size: 0;
    }
    .file-select input[type="file"]::file-selector-button {
      font-size: 14px;
    }
    .play-controls { margin-bottom: 10px; }
    #usage div { margin-bottom: 4px; }
    #usage progress {
      width: 60%;
      height: 20px;
      --bar-color: green;
    }
    #usage progress::-webkit-progress-value { background-color: var(--bar-color); }
    #usage progress::-moz-progress-bar { background-color: var(--bar-color); }
    @media (max-width: 768px) {
      body { flex-direction: column; height: auto; }
      .video-container, .chat-container { width: 100%; }
      #usage progress { width: 100%; }
    }
  </style>
</head>
<body>
  <!-- 動画 -->
  <div class="video-container">
    <div class="file-select">
      <label for="ref-upload">参照</label>
      <input id="ref-upload" type="file" accept="video/mp4" />
      <select id="ref-file"></select>
      <br />
      <label for="cur-upload">対象</label>
      <input id="cur-upload" type="file" accept="video/mp4" />
      <select id="cur-file"></select>
      <br />
      <label for="device-select">デバイス</label>
      <select id="device-select">
        <option value="CPU">CPU</option>
        <option value="GPU">GPU</option>
        <option value="NPU">NPU</option>
      </select>
      <br />
      <button id="process-btn">更新＆解析</button>
    </div>
    <div id="status"></div>
    <div id="usage">
      <div>CPU: <progress id="cpu-bar" max="100" value="0"></progress> <span id="cpu-text">0%</span></div>
      <div>GPU: <progress id="gpu-bar" max="100" value="0"></progress> <span id="gpu-text">0%</span></div>
      <div>NPU: <progress id="npu-bar" max="100" value="0"></progress> <span id="npu-text">0%</span></div>
      <div>メモリ: <progress id="mem-bar" max="100" value="0"></progress> <span id="mem-text">0%</span> <span id="mem-detail"></span></div>
    </div>
    {% if has_results %}
    <p>スイングスコア: {{ "%.4f"|format(score) }}</p>
    <div class="play-controls">
      <button id="play-both-btn">同時再生</button>
      <button id="stop-both-btn">停止</button>
    </div>
    <div class="video-wrapper">
      <div class="video-item">
        <video id="ref-video" controls loop>
          <source src="{{ url_for('serve_video', filename=ref_video_name) }}" type="video/mp4">
          お使いのブラウザは動画再生に対応していません。
        </video>
        <canvas id="ref-canvas"></canvas>
      </div>
      <div class="video-item">
        <video id="cur-video" controls loop>
          <source src="{{ url_for('serve_video', filename=cur_video_name) }}" type="video/mp4">
          お使いのブラウザは動画再生に対応していません。
        </video>
        <canvas id="cur-canvas"></canvas>
      </div>
    </div>
    {% endif %}
  </div>

  {% if chatbot_enabled %}
  <!-- チャット -->
  <div class="chat-container">
    <div id="chat-status" class="chat-status preparing">
      チャットボットは準備中です。まず動画を分析してください。
    </div>
    <div id="chat-messages"></div>
    <div class="chat-input">
      <input id="chat-input" type="text" placeholder="メッセージを入力..." disabled />
      <button id="send-btn" disabled>送信</button>
    </div>
  </div>
  {% endif %}

  <script>
    const HAS_RESULTS = {{ 'true' if has_results else 'false' }};
    const CHATBOT_ENABLED = {{ 'true' if chatbot_enabled else 'false' }};
    const CURRENT_DEVICE = '{{ device }}';
    const REF_KP_URL = '{{ url_for('static', filename=ref_kp_name) }}';
    const CUR_KP_URL = '{{ url_for('static', filename=cur_kp_name) }}';

    let chatbotReady = false;

    // --- OpenPose skeleton drawing ---
    const POSE_PAIRS = [
      [1, 2], [2, 3], [3, 4], [1, 5], [5, 6], [6, 7],
      [1, 8], [8, 9], [9, 10], [8, 12], [12, 13], [13, 14],
      [0, 1], [0, 15], [15, 17], [0, 16], [16, 18]
    ];

    function drawSkeleton(ctx, keypoints, w, h) {
      ctx.clearRect(0, 0, w, h);
      keypoints.forEach(([x, y, c]) => {
        if (c > 0.3) {
          ctx.beginPath();
          ctx.arc(x * w, y * h, 4, 0, 2 * Math.PI);
          ctx.fillStyle = 'rgb(0,255,0)';
          ctx.fill();
        }
      });
      POSE_PAIRS.forEach(([a, b]) => {
        if (a < keypoints.length && b < keypoints.length) {
          const [x1, y1, c1] = keypoints[a];
          const [x2, y2, c2] = keypoints[b];
          if (c1 > 0.3 && c2 > 0.3) {
            ctx.beginPath();
            ctx.moveTo(x1 * w, y1 * h);
            ctx.lineTo(x2 * w, y2 * h);
            ctx.strokeStyle = 'rgb(255,0,0)';
            ctx.lineWidth = 2;
            ctx.stroke();
          }
        }
      });
    }

    async function setupCanvas(videoId, canvasId, jsonUrl) {
      try {
        const res = await fetch(jsonUrl);
        const data = await res.json();
        const fps = data.fps || 30;
        const kps = data.keypoints || [];
        const video = document.getElementById(videoId);
        const canvas = document.getElementById(canvasId);
        const ctx = canvas.getContext('2d');

        video.addEventListener('loadedmetadata', () => {
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
        });

        let reqId;
        function render() {
          if (video.paused || video.ended) return;
          const idx = Math.min(Math.floor(video.currentTime * fps), kps.length - 1);
          if (idx >= 0) {
            drawSkeleton(ctx, kps[idx], canvas.width, canvas.height);
          }
          reqId = requestAnimationFrame(render);
        }

        video.addEventListener('play', () => {
          reqId = requestAnimationFrame(render);
        });
        video.addEventListener('pause', () => cancelAnimationFrame(reqId));
        video.addEventListener('seeked', () => {
          const idx = Math.min(Math.floor(video.currentTime * fps), kps.length - 1);
          if (idx >= 0) {
            drawSkeleton(ctx, kps[idx], canvas.width, canvas.height);
          }
        });
      } catch (e) {
        console.error('Failed to load keypoints:', e);
      }
    }

    // --- チャットボット状態更新 ---
    async function update_chatbot_status() {
      try {
        const res = await fetch('/chatbot_status');
        const status = await res.json();
        const statusDiv = document.getElementById('chat-status');
        const chatInput = document.getElementById('chat-input');
        const sendBtn = document.getElementById('send-btn');
        
        if (status.initialized || status.analysis_complete) {
          statusDiv.textContent = "動画分析が完了しました。チャットボットの準備ができました！";
          statusDiv.className = "chat-status ready";
          chatInput.disabled = false;
          sendBtn.disabled = false;
          chatInput.placeholder = "メッセージを入力...";
          chatbotReady = true;
        } else {
          statusDiv.textContent = "チャットボットは準備中です。まず動画を分析してください。";
          statusDiv.className = "chat-status preparing";
          chatInput.disabled = true;
          sendBtn.disabled = true;
          chatbotReady = false;
        }
      } catch (e) {
        const statusDiv = document.getElementById('chat-status');
        statusDiv.textContent = "チャットボット状態の取得に失敗しました。";
        statusDiv.className = "chat-status error";
        chatbotReady = false;
      }
    }

    // --- メッセージ読み込み ---
    async function load_messages() {
      if (!chatbotReady) return;
      try {
        const res = await fetch('/messages');
        const msgs = await res.json();
        const box = document.getElementById('chat-messages');
        box.innerHTML = '';
        msgs.forEach(m => {
          const p = document.createElement('p');
          const prefix = m.role === 'user' ? 'あなた: ' : 'コーチ: ';
          p.textContent = prefix + m.content;
          box.appendChild(p);
        });
        box.scrollTop = box.scrollHeight;
      } catch (e) {
        console.error('Failed to load messages:', e);
      }
    }

    // --- チャット初期化 ---
    async function init_chat() {
      await update_chatbot_status();
      if (HAS_RESULTS) {
        const statusDiv = document.getElementById('chat-status');
        const chatInput = document.getElementById('chat-input');
        const sendBtn = document.getElementById('send-btn');
        statusDiv.textContent = "動画分析が完了しました。チャットボットの準備ができました！";
        statusDiv.className = "chat-status ready";
        chatInput.disabled = false;
        sendBtn.disabled = false;
        chatInput.placeholder = "メッセージを入力...";
        chatbotReady = true;
      }
      try { await fetch('/init_chatbot', { method: 'POST' }); } catch (_) {}
      await update_chatbot_status();
      await load_messages();
    }

    // --- メッセージ送信 ---
    if (document.getElementById('chat-input')) {
      document.getElementById('send-btn').onclick = async () => {
        if (!chatbotReady) return;
        const input = document.getElementById('chat-input');
        const text = input.value.trim();
        if (!text) return;
        const box = document.getElementById('chat-messages');

        const userP = document.createElement('p');
        userP.textContent = 'あなた: ' + text;
        box.appendChild(userP);
        input.value = '';

        const loadingP = document.createElement('p');
        loadingP.textContent = 'コーチ: 考え中...';
        loadingP.style.opacity = '0.6';
        box.appendChild(loadingP);

        try {
          const res = await fetch('/messages', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: text })
          });
          const data = await res.json();
          box.removeChild(loadingP);
          const coachP = document.createElement('p');
          coachP.textContent = 'コーチ: ' + data.reply;
          box.appendChild(coachP);
        } catch (e) {
          box.removeChild(loadingP);
          const errP = document.createElement('p');
          errP.textContent = 'コーチ: 返答の取得に失敗しました。';
          errP.style.color = 'red';
          box.appendChild(errP);
        }
        box.scrollTop = box.scrollHeight;
      };

      document.getElementById('chat-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey && chatbotReady) {
          e.preventDefault();
          document.getElementById('send-btn').click();
        }
      });
    }

    // --- 解析ボタン ---
    document.getElementById('process-btn').onclick = async () => {
      const refUp = document.getElementById('ref-upload').files[0];
      const curUp = document.getElementById('cur-upload').files[0];
      const refSel = document.getElementById('ref-file').value;
      const curSel = document.getElementById('cur-file').value;
      const device = document.getElementById('device-select').value;

      let refFile = refSel, curFile = curSel;
      if (refUp || curUp) {
        const form = new FormData();
        if (refUp) form.append('reference', refUp);
        if (curUp) form.append('current', curUp);
        const upRes = await fetch('/upload_videos', { method: 'POST', body: form });
        const uploaded = await upRes.json();
        if (uploaded.reference_file) refFile = uploaded.reference_file;
        if (uploaded.current_file) curFile = uploaded.current_file;
      }

      await fetch('/set_videos', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ reference_file: refFile, current_file: curFile, device })
      });

      const status = document.getElementById('status');
      status.textContent = '動画解析中です。完了までお待ちください';
      
      if (CHATBOT_ENABLED) {
        const statusDiv = document.getElementById('chat-status');
        statusDiv.textContent = "動画解析中です。完了までお待ちください...";
        statusDiv.className = "chat-status preparing";
        document.getElementById('chat-input').disabled = true;
        document.getElementById('send-btn').disabled = true;
        chatbotReady = false;
      }

      let dots = 0;
      const timer = setInterval(() => {
        dots = (dots + 1) % 4;
        status.textContent = '動画解析中です。完了までお待ちください' + '.'.repeat(dots);
      }, 500);

      let analyzeData = null;
      try {
        const analyzeRes = await fetch('/analyze', { method: 'POST' });
        analyzeData = await analyzeRes.json();
      } catch (e) {
        clearInterval(timer);
        status.textContent = '解析に失敗しました。';
        return;
      }
      clearInterval(timer);

      if (analyzeData && analyzeData.error) {
        status.textContent = '解析に失敗しました: ' + analyzeData.error;
        return;
      }

      // ✅ 成功時: フロント側で強制的に完了状態へ
      status.textContent = '動画解析が完了しました';
      if (CHATBOT_ENABLED) {
        const statusDiv = document.getElementById('chat-status');
        const chatInput = document.getElementById('chat-input');
        const sendBtn = document.getElementById('send-btn');
        statusDiv.textContent = "動画分析が完了しました。チャットボットの準備ができました！";
        statusDiv.className = "chat-status ready";
        chatInput.disabled = false;
        sendBtn.disabled = false;
        chatInput.placeholder = "メッセージを入力...";
        chatbotReady = true;
        load_messages().catch(() => {});
      }

      setTimeout(() => location.reload(), 1000);
    };

    // --- 動画リスト読み込み ---
    async function load_video_list() {
      const res = await fetch('/list_videos');
      const files = await res.json();
      const refSel = document.getElementById('ref-file');
      const curSel = document.getElementById('cur-file');
      refSel.innerHTML = '';
      curSel.innerHTML = '';

      files.forEach(f => {
        const o1 = document.createElement('option');
        o1.value = f;
        o1.textContent = f;
        refSel.appendChild(o1);

        const o2 = document.createElement('option');
        o2.value = f;
        o2.textContent = f;
        curSel.appendChild(o2);
      });

      refSel.value = '{{ ref_video_name }}';
      curSel.value = '{{ cur_video_name }}';
    }

    // 初期化
    load_video_list();
    document.getElementById('device-select').value = CURRENT_DEVICE;
    if (HAS_RESULTS) {
      setupCanvas('ref-video', 'ref-canvas', REF_KP_URL);
      setupCanvas('cur-video', 'cur-canvas', CUR_KP_URL);
      const playBtn = document.getElementById('play-both-btn');
      if (playBtn) {
        playBtn.addEventListener('click', () => {
          const ref = document.getElementById('ref-video');
          const cur = document.getElementById('cur-video');
          if (ref && cur) {
            ref.currentTime = 0;
            cur.currentTime = 0;
            ref.play();
            cur.play();
          }
        });
      }
      const stopBtn = document.getElementById('stop-both-btn');
      if (stopBtn) {
        stopBtn.addEventListener('click', () => {
          const ref = document.getElementById('ref-video');
          const cur = document.getElementById('cur-video');
          if (ref && cur) {
            ref.pause();
            cur.pause();
            ref.currentTime = 0;
            cur.currentTime = 0;
          }
        });
      }
    }
    if (document.getElementById('chat-input')) {
      init_chat();
      setInterval(update_chatbot_status, 5000);
    }

    // --- 使用率更新 ---
    function usageColor(v) {
      if (v < 25) return 'green';
      if (v < 50) return 'blue';
      if (v < 75) return 'yellow';
      return 'red';
    }

    async function update_usage() {
      try {
        const res = await fetch('/system_usage');
        const data = await res.json();

        document.getElementById('cpu-bar').value = data.cpu;
        document.getElementById('gpu-bar').value = data.gpu;
        document.getElementById('npu-bar').value = data.npu;
        document.getElementById('mem-bar').value = data.memory_percent;

        document.getElementById('cpu-text').textContent = `${data.cpu.toFixed(1)}%`;
        document.getElementById('gpu-text').textContent = `${data.gpu.toFixed(1)}%`;
        document.getElementById('npu-text').textContent = `${data.npu.toFixed(1)}%`;
        document.getElementById('mem-text').textContent = `${data.memory_percent.toFixed(1)}%`;
        document.getElementById('mem-detail').textContent = `${data.memory_used_gb.toFixed(2)} / ${data.memory_total_gb.toFixed(2)} GB`;

        document.getElementById('cpu-bar').style.setProperty('--bar-color', usageColor(data.cpu));
        document.getElementById('gpu-bar').style.setProperty('--bar-color', usageColor(data.gpu));
        document.getElementById('npu-bar').style.setProperty('--bar-color', usageColor(data.npu));
        document.getElementById('mem-bar').style.setProperty('--bar-color', usageColor(data.memory_percent));

        document.getElementById('cpu-text').style.color = usageColor(data.cpu);
        document.getElementById('gpu-text').style.color = usageColor(data.gpu);
        document.getElementById('npu-text').style.color = usageColor(data.npu);
        document.getElementById('mem-text').style.color = usageColor(data.memory_percent);
      } catch (_) {}
    }
    setInterval(update_usage, 1000);
    update_usage();
  </script>
</body>
</html>
