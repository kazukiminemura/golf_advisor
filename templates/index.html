<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>チャット & 動画</title>
  <link rel="stylesheet" href="{{ request.url_for('static', path='css/styles.css') }}?v=4">
</head>
<body>
  <!-- 動画 -->
  <div class="video-container">
    <div class="file-select">
      <label for="ref-upload">プロ</label>
      <input id="ref-upload" type="file" accept="video/mp4" />
      <select id="ref-file"></select>
      <br />
      <label for="cur-upload">対象</label>
      <input id="cur-upload" type="file" accept="video/mp4" />
      <select id="cur-file"></select>
      <br />
      <label for="device-select">デバイス</label>
      <select id="device-select">
        <option value="CPU">CPU</option>
        <option value="GPU">GPU</option>
        <option value="NPU">NPU</option>
      </select>
      <br />
      <button id="process-btn">更新</button>
    </div>
    <div id="status"></div>
    <hr class="usage-separator" />
    <div class="usage-title">H/W使用状況</div>
    <div id="usage">
      <div class="usage-item"><span class="label"><span class="icon">🖥</span>CPU</span><progress id="cpu-bar" max="100" value="0"></progress><span class="value" id="cpu-text">0%</span></div>
      <div class="usage-item"><span class="label"><span class="icon">🎮</span>GPU</span><progress id="gpu-bar" max="100" value="0"></progress><span class="value" id="gpu-text">0%</span></div>
      <div class="usage-item"><span class="label"><span class="icon">🤖</span>NPU</span><progress id="npu-bar" max="100" value="0"></progress><span class="value" id="npu-text">0%</span></div>
      <div class="usage-item">
        <span class="label"><span class="icon">💾</span>メモリ</span>
        <progress id="mem-bar" max="100" value="0"></progress>
        <div class="value-detail">
          <span class="value" id="mem-text">0%</span>
          <!-- <span class="detail" id="mem-detail"></span> -->
        </div>
      </div>
    </div>
    {% if has_results %}
    <p>スイングスコア: {{ "%.4f"|format(score) }}</p>
    <div class="play-controls">
      <button id="play-both-btn">同時再生</button>
      <button id="stop-both-btn">停止</button>
    </div>
    <div class="video-wrapper">
      <div class="video-item pro">
        <video id="ref-video" controls loop>
          <source src="{{ request.url_for('serve_video', filename=ref_video_name) }}" type="video/mp4">
          お使いのブラウザは動画再生に対応していません。
        </video>
        <canvas id="ref-canvas"></canvas>
      </div>
      <div class="video-item target">
        <video id="cur-video" controls loop>
          <source src="{{ request.url_for('serve_video', filename=cur_video_name) }}" type="video/mp4">
          お使いのブラウザは動画再生に対応していません。
        </video>
        <canvas id="cur-canvas"></canvas>
      </div>
    </div>
    {% endif %}
  </div>

  {% if chatbot_enabled %}
  <!-- チャット -->
  <div class="chat-container">
    <div id="chat-status" class="chat-status preparing">
      チャットボットを準備中です。まず動画を解析してください。
    </div>
    <div id="chat-messages"></div>
    <div class="chat-input">
      <input id="chat-input" type="text" placeholder="質問してみましょう" disabled />
      <button id="send-btn" disabled title="送信">➤</button>
    </div>
  </div>
  {% endif %}

  <script>
    window.APP_CONFIG = {
      hasResults: {{ 'true' if has_results else 'false' }},
      chatbotEnabled: {{ 'true' if chatbot_enabled else 'false' }},
      device: '{{ device }}',
      refKpUrl: '{{ request.url_for('static', path=ref_kp_name) }}',
      curKpUrl: '{{ request.url_for('static', path=cur_kp_name) }}',
      refVideoName: '{{ ref_video_name }}',
      curVideoName: '{{ cur_video_name }}'
    };
  </script>
  <script type="module" src="{{ request.url_for('static', path='js/main.js') }}?v=2"></script>
</body>
</html>

